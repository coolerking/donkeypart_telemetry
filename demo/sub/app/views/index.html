<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Donkey Telemetry</title>
    <meta name="description" content="Speed Level Telemetry from Donkey Car via MQTT">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .label{
	        font-size:22.5px;
	        fill:#ffffff;
	        text-anchor:middle;
	        alignment-baseline:middle;
        }
        .face{
	        stroke:#c8c8c8;
	        stroke-width:2;
        }
        .minorTicks{
	        stroke-width:2;
	        stroke:white;
        }
        .majorTicks{
	        stroke:white;
	        stroke-width:3;
        }
    </style>
  </head>
  <body>
    <h1> Donkey Telemetry</h1>
    <svg width="900" height="700"></svg>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="http://vizjs.org/viz.v1.0.0.min.js"></script>
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script>
        let svg=d3.select("svg");
        let g=svg.append("g").attr("transform","translate(450,350)");
        let domain = [0,100];

        let gg = viz.gg()
            .domain(domain)
            .outerRadius(300)
            .innerRadius(30)
            .value(0.5*(domain[1]+domain[0]))
            .duration(1000);
      
        gg.defs(svg);
        g.call(gg);  
    
        d3.select(self.frameElement).style("height", "700px");

        setInterval( function(){
            $.ajax({
                url: '/telemetry',
                type: 'POST',
                data:{}
            })
            .done( (msg) => {
                console.log("[done] arrive")
                json = JSON.parse(msg)
                console.log("[done] use " + json.throttle)
                gg.setNeedle(json.throttle)
            })
            .fail( (msg) => {
                console.log("[fail]")
                console.log(msg)
            })
            .always( (msg) => {
            });},
        1300);

    </script>

  </body>
</html>